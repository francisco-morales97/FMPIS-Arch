#!/bin/sh

# Definición de variables
GREEN="\033[0;32m"
RED="\033[0;31m"
BOLD="\033[1m"
NC="\033[0m"

# Inicio del script
[ ! -f "$1" ] && printf "${RED}${BOLD}Debes colocar el archivo 'tracks'${NC}\n" && exit

TRACK=0
TOTAL="$(wc -l < $1)"

# Proceso de conversión de canciones

# Ordeno las canciones por orden de descarga y reemplazo los espacios por 
# signos de grado para que, al ejecutar el loop, los nombres de cada cancion
# sean tratados como una sola linea
SONGS=$(ls *.m4a --time=creation -r | sed "s/ /°/g")

for SONG in $SONGS; do
  TRACK="$(printf "%02d" "$(expr $TRACK + 1)")"
  SONGNAME="$(printf "$SONG" | sed "s/°/ /g;s/-.*\.//g;s/m4a$/-$TRACK/g" | awk -F - '{print $2,$1}' | sed "s/\s/ - /")"
  printf "Convirtiendo '$(printf $SONG | sed "s/°/ /g;s/-.*//g")'\n"

  # Revierto los signos de grado a espacios para que ffmpeg reconozca el 
  # nombre original del archivo y pueda convertirlo de formato
  ffmpeg -nostdin -loglevel 16 -i "$(printf $SONG | sed "s/°/ /g")" "$SONGNAME.opus"
done

# Proceso de etiquetado de canciones

# Metadatos generales
echo
printf "Nombre del album:\n"; read -r ALBUM
printf "Nombre del artista:\n"; read -r ARTIST
printf "Año de publicación:\n"; read -r DATE
printf "Género del album:\n"; read -r GENRE
EXIT=false
while [ $EXIT = false ]; do
  printf "¿El album posee discos múltiples? [y/n]\n"; read ANSWER
  case $ANSWER in
    y)
      printf "Número de disco:\n"; read -r DISCNUMBER
      EXIT=true
      ;;
    n)
      EXIT=true
      ;;
    *)
      echo
      printf "${RED}${BOLD}Esa opción no es válida${NC}\n"
      ;;
  esac
done
echo
TRACK=0
 
# Aplicar dichos metadatos según el album sea multidisco
if [ -n "$DISCNUMBER" ]; then
  for SONG in *.opus; do
    NAME="$(printf "$SONG" | sed "s/.*-\s//g;s/.opus$//g")"
    TRACK="$(printf "$(expr $TRACK + 1)")"
    printf "Escribiendo metadatos de '$SONG'\n"
    opustags "$SONG" --in-place -D
    opustags "$SONG" --in-place -a "TITLE=$NAME" -a "ALBUM=$ALBUM" -a "ARTIST=$ARTIST" -a "DATE=$DATE" -a "GENRE=$GENRE" -a "TRACKNUMBER=$TRACK" -a "TOTALTRACKS=$TOTAL" -a "DISCNUMBER=$DISCNUMBER"
  done
else
  for SONG in *.opus; do
    NAME="$(printf "$SONG" | sed "s/.*-\s//g;s/.opus$//g")"
    TRACK="$(printf "$(expr $TRACK + 1)")"
    printf "Escribiendo metadatos de '$SONG'\n"
    opustags "$SONG" --in-place -D
    opustags "$SONG" --in-place -a "TITLE=$NAME" -a "ALBUM=$ALBUM" -a "ARTIST=$ARTIST" -a "DATE=$DATE" -a "GENRE=$GENRE" -a "TRACKNUMBER=$TRACK" -a "TOTALTRACKS=$TOTAL"
  done
fi

# Diálogo para remover archivos sobrantes

EXIT=false
while [ $EXIT = false ]; do
  echo
  printf "¿Desea remover los archivos sobrantes? [y/n]\n" && read ANSWER
  case "$ANSWER" in
    y)
      rm *.m4a tracks
      echo
      printf "${GREEN}${BOLD}¡Proceso Finalizado!${NC}\n"
      EXIT=true
      ;;
    n)
      echo
      printf "${GREEN}${BOLD}¡Proceso finalizado!${NC}\n"
      EXIT=true
      ;;
    *)
      echo
      printf "${RED}${BOLD}Esa opción no es válida${NC}\n"
      ;;
  esac
done
